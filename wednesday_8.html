
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://gutomaia.net/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://gutomaia.net/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://gutomaia.net/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://gutomaia.net/['/css/hacks.css']" rel="stylesheet">

    <link href="https://gutomaia.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="gutomaia Atom">


    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Guto Maia" />
<meta name="description" content="A Long Time Ago It's been a while since my last update, and if you've been visiting this page eagerly awaiting news, thank you for your patience. Let's dive right in. Recently, I've been using the "wedNESday" project to thoroughly test NES emulators and improve them. In a Galaxy Far …" />
<meta name="keywords" content="6502, nes, python, wedNESday">
<meta property="og:site_name" content="gutomaia"/>
<meta property="og:title" content="wedNESday #8 - A long delay"/>
<meta property="og:description" content="A Long Time Ago It's been a while since my last update, and if you've been visiting this page eagerly awaiting news, thank you for your patience. Let's dive right in. Recently, I've been using the "wedNESday" project to thoroughly test NES emulators and improve them. In a Galaxy Far …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://gutomaia.net/wednesday_8.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2024-04-24 16:20:00-03:00"/>
<meta property="article:modified_time" content="2024-04-24 16:20:00-03:00"/>
<meta property="article:author" content="https://gutomaia.net/author/guto-maia.html">
<meta property="article:section" content="nes"/>
<meta property="article:tag" content="6502"/>
<meta property="article:tag" content="nes"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="wedNESday"/>
<meta property="og:image" content="https://s.gravatar.com/avatar/760d34405db2c028a3fb099a4510d870?s=100">

  <title>gutomaia &ndash; wedNESday #8 - A long delay</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-8039666399992046",
      enable_page_level_ads: true
    });
  </script>
</head>
<body>
  <aside>
    <div>
      <a href="https://gutomaia.net">
        <img src="https://s.gravatar.com/avatar/760d34405db2c028a3fb099a4510d870?s=100" alt="gutomaia" title="gutomaia">
      </a>
      <h1><a href="https://gutomaia.net">gutomaia</a></h1>

<p>Pythonist with a NES and an ☂</p>
      <nav>
        <ul class="list">

          <li><a href="/pyNES" target="_blank">pyNES</a></li>
          <li><a href="/nodeNES" target="_blank">nodeNES</a></li>
          <li><a href="/TylerD" target="_blank">TylerD</a></li>
          <li><a href="/wedNESday/0.0.x" target="_blank">wedNESday</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/gutomaia" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/gutomaia" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="http://linkedin.com/in/gutomaia" target="_blank"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-responsive"
           data-ad-client="ca-pub-8039666399992046"
           data-ad-slot="2727902218"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>


<article class="single">
  <header>
    <h1 id="wednesday_8">wedNESday #8 - A long delay</h1>
    <p>
          Posted on Wed 24 April 2024 in <a href="https://gutomaia.net/category/nes.html">nes</a>


    </p>
  </header>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-8039666399992046"
         data-ad-slot="2588301415"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

  <div>
    <div class="figure align-center">
<img alt="a long time ago" src="https://gutomaia.net/images/a_long_time_ago.webp" />
</div>
<div class="section" id="a-long-time-ago">
<h2>A Long Time Ago</h2>
<p>It's been a while since my last update, and if you've been visiting this page eagerly awaiting news, thank you for your patience. Let's dive right in. Recently, I've been using the &quot;wedNESday&quot; project to thoroughly test NES emulators and improve them.</p>
</div>
<div class="section" id="in-a-galaxy-far-far-away">
<h2>In a Galaxy Far Far Away</h2>
<p>Emulators are being tested using a CPU specification derived from <a class="reference external" href="https://github.com/nwidger/nintengo/blob/master/m65go2/instructions_test.go">Nintego</a>. Here are the emulators I've been putting through their paces:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ergoadams/arbne">Arbne</a>: Discovered in a serendipitous encounter within a <a class="reference external" href="https://www.reddit.com/r/EmuDev/comments/gc5w8w/a_really_bad_nes_emulator_in_python_feedback/">Reddit thread</a>, a call for feedback that demands an answer.</li>
<li><a class="reference external" href="https://github.com/jtauber/applepy">ApplePy</a>: An Apple 2 emulator by James Tauber, although not a NES emulator, it relies on the 6502 architecture.</li>
<li><a class="reference external" href="https://github.com/bfirsh/jsnes">JSnes</a>: A NES emulator written in Javascript, pivotal for my experiments in nodeNES.</li>
<li><a class="reference external" href="https://github.com/PyAndy/Py3NES">Py3NES</a>: Constructed amidst live streaming sessions, Py3NES offers a fascinating insight into NES emulation, with its entire development journey documented on <a class="reference external" href="https://www.youtube.com/channel/UCT0oEArSloMLL_URLyy2HfA">YouTube</a>.</li>
<li><a class="reference external" href="https://github.com/mnaberez/py65">Py65</a>: A Python-based 6502 emulator, serving as a critical component in the testing arsenal.</li>
<li><a class="reference external" href="https://github.com/jameskmurphy/nes">Pyntendo</a>: Implemented also CPython, Pyntendo promises an intriguing exploration into NES emulation.</li>
<li><a class="reference external" href="https://github.com/Torlus/6502.js">6502js</a>: Gregory Estrade's 6502 emulator, a very interesting for quest for accuracy and reliability.</li>
</ul>
<p>The Goal is to improve the overwall accuracy</p>
</div>
<div class="section" id="summary-of-results">
<h2>Summary of Results</h2>
<p>The following table succinctly summarizes the outcomes gleaned from the 6502 instruction tests:</p>
<!-- Color profiles for Sphinx. -->
<!-- Has to be used with hacks.css -->
<!-- (https://bitbucket.org/lbesson/web-sphinx/src/master/.static/hacks.css) -->
<!-- (c) Lilian Besson, 2011-2016, https://bitbucket.org/lbesson/web-sphinx/ -->
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Instruction</th>
<th class="head">ApplePy</th>
<th class="head">Arbne</th>
<th class="head">JSnes</th>
<th class="head">Py3NES</th>
<th class="head">Py65</th>
<th class="head">Pyntendo</th>
<th class="head">6502js</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>adc immediate with bcd</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>bcc</td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>beq</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>bne</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>brk</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>irq interrupt</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>jsr</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>jsr stack pointer</td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>jsr with illegal opcode</td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>nmi interrupt</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>php</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>pla</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>pla n flag set</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>pla z flag set</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>plp</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>rst interrupt</td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>rti</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>rts</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
</tr>
<tr><td>sbc immediate with bcd</td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>tsx</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
<tr><td>txs</td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="red">NOT</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
<td><span class="green">OK</span></td>
</tr>
</tbody>
</table>
<p>You can find an updated version of this table at <a class="reference external" href="https://gutomaia.net/wedNESday/0.0.x/instructions.html#cpu-failed-tests">ẁedNESday's documentation</a>.</p>
</div>
<div class="section" id="result-details">
<h2>Result Details</h2>
<p>NES emulators typically do not implement the decimal mode, rendering ADC and SEC operations with BCD optional, whereas these functionalities are essential for 6502 emulators. Currently, my focus lies on refining the interrupt specification. That's explain why irq, nmi, and reset interruption tests fail across all emulators.</p>
<ul class="simple">
<li><strong>PLP Instruction Issue:</strong> Across all emulators, the PLP instruction presents a notable issue, which will be addressed in further detail in a dedicated topic.</li>
<li><strong>ApplePy Limitations:</strong> ApplePy lacks implementations for math operations with BCD and interrupts.</li>
<li><strong>Arbne Quirk:</strong> Arbne exhibits a minor issue with the BRK instruction, specifically concerning the return of the Program Counter, resulting in a peculiar plus one offset.</li>
<li><strong>JSnes Challenges:</strong> JSnes faces challenges with all branch instructions, JSR, and RTS due to issues with instructions that alter the Program Counter position. This may stem from underlying logic in the bridge.</li>
<li><strong>Py3NES BRK Issue:</strong> Py3NES encounters an issue with the BRK instruction.</li>
<li><strong>Py65 Differences:</strong> Py65 demonstrates discrepancies in the behavior of jump instructions.</li>
<li><strong>Pyntendo</strong>, Pytendo has only a minor issue with invalid opcodes.</li>
<li><strong>6502js Procedure Call:</strong> The 6502.js emulator encounters issues with the JSR (Jump to Subroutine) and RTS (Return from Subroutine) instructions. These issues impact the proper execution of subroutine calls and returns.</li>
<li><strong>Number of Cycles:</strong> Across all emulators, I found it necessary to disable cycle checking in certain instructions to ensure proper functionality. I will be publishing a new table documenting these instances where cycle checking had to be skipped.</li>
</ul>
<p>In response to these findings, I've initiated forks of each emulator to address the some of the identified issues. The goal is to synchronize the behavior of all emulators, ensuring consistency and compatibility. To achieve this, I'm focusing on improving the test cases for instructions such as BRK, JSR, PLP, and RST, which are crucial for accurate emulation.</p>
<div class="section" id="plp-instruction">
<h3>PLP Instruction</h3>
<p>The PLP instruction, short for &quot;Pull Processor Status from Stack,&quot; retrieves the last value from the stack and updates the Status register accordingly. It affects all flags except the Break (B) and Unused (U) flags.</p>
<p>Essentially, this means that whatever value the B flag had before the PLP execution will remain unchanged afterward, as will the U flag. According to the <a class="reference external" href="https://github.com/nwidger/nintengo/blob/f173d610a4acece3bb01a6564fe0f35b1a0ed7ac/m65go2/instructions_test.go#L1210">Nintego PLP Test</a>, if the value 0xFF is pushed onto the stack, PLP will pull 0xCF into the Status register.</p>
<p>However, giving the Nintengo example, it's worth noting that although fetching the U flag will always return &quot;1&quot;, although the corresponding bit in the status register is now set to 0 (0xCF). Further testing on real hardware may be necessary to validate this behavior.</p>
<div class="highlight"><pre><span></span><span class="nf">STX</span><span class="w"> </span><span class="no">$FF</span>
<span class="nf">TXS</span>
<span class="nf">PLP</span>
<span class="nf">JSR</span><span class="w"> </span><span class="no">print_p_reg</span>
<span class="nf">JSR</span><span class="w"> </span><span class="no">print_flags</span>
</pre></div>
</div>
<div class="section" id="testing-specification">
<h3>Testing Specification</h3>
<p>I often emphasize that a good test is built upon a solid specification. Following the principles of Lean Architecture and Model Driven Architecture (MDA), I consider a specification to be effective when it exhibits the following characteristics:</p>
<ul class="simple">
<li><strong>Self-contained:</strong> A good specification should be self-contained, meaning it doesn't rely on any external references. It defines the scope of the problem within itself, providing clear boundaries for testing.</li>
<li><strong>Platform Independent:</strong> A specification should be platform independent, meaning it can be applied uniformly across different environments and architectures. This ensures consistency and compatibility, regardless of the underlying technology stack or infrastructure.</li>
<li><strong>Abstracted:</strong> A specification should be abstracted, avoiding implementation details or reliance on concrete methods. This ensures flexibility and adaptability, allowing for changes or enhancements without impacting the overall testing framework.</li>
<li><strong>Extendable:</strong> An ideal specification is designed to be extendable, capable of accommodating future requirements or modifications. This flexibility enables the testing framework to evolve alongside the project it supports.</li>
<li><strong>Readable:</strong> Perhaps most importantly, a specification must be readable by humans. Clear and concise documentation ensures that the intent and requirements of the system under test are easily understood, facilitating collaboration and maintenance efforts.</li>
</ul>
<p>While the CPU specs still lack complete abstraction due to explicit calls to assert methods from the unittest.TestCase mixin, efforts are underway to further abstract these specifications in alignment with these principles.</p>
<p>Aside from the <cite>abstracted</cite>, which the CPU specs still lacks since it does explicit calls assert methods from the unittest.TestCase as a mixin.</p>
</div>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://gutomaia.net/tag/6502.html">6502</a>
      <a href="https://gutomaia.net/tag/nes.html">nes</a>
      <a href="https://gutomaia.net/tag/python.html">python</a>
      <a href="https://gutomaia.net/tag/wednesday.html">wedNESday</a>
    </p>
  </div>



    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-8039666399992046"
         data-ad-slot="4065034611"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

</article>

    <footer>
<p>&copy; Guto Maia 2024</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-32666248-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " gutomaia ",
  "url" : "https://gutomaia.net",
  "image": "https://s.gravatar.com/avatar/760d34405db2c028a3fb099a4510d870?s=100",
  "description": ""
}
</script>
</body>
</html>